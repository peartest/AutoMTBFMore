"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.SafariNetworkLog = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _url = _interopRequireDefault(require("url"));

var _appiumSupport = require("appium-support");

var _rotatingLog = require("./rotating-log");

class SafariNetworkLog extends _rotatingLog.RotatingLog {
  constructor(showLogs) {
    super(showLogs, 'SafariNetwork');
  }

  getEntry(requestId) {
    let outputEntry;

    while (this.logs.length >= _rotatingLog.MAX_LOG_ENTRIES_COUNT) {
      const entry = this.logs.shift();

      if (entry && entry.requestId === requestId) {
        outputEntry = entry;
        this.logs.push(outputEntry);
        continue;
      }

      if (this.logIdxSinceLastRequest > 0) {
        this.logIdxSinceLastRequest--;
      }
    }

    if (!outputEntry) {
      for (let i = this.logs.length - 1; i >= 0; i--) {
        if (this.logs[i].requestId === requestId) {
          outputEntry = this.logs[i];
          this.logs.splice(i, 1);
          break;
        }
      }

      if (!outputEntry) {
        outputEntry = {
          requestId,
          logs: []
        };
      }

      this.logs.push(outputEntry);
    }

    return outputEntry;
  }

  addLogLine(method, out) {
    if (!this.isCapturing && !this.showLogs) {
      return;
    }

    if (['Network.dataReceived'].includes(method)) {
      return;
    }

    const outputEntry = this.getEntry(out.requestId);

    if (this.isCapturing) {
      outputEntry.logs = outputEntry.logs || [];
      outputEntry.logs.push(out);
    }

    if (!this.showLogs) {
      return;
    }

    if (method === 'Network.loadingFinished' || method === 'Network.loadingFailed') {
      this.printLogLine(outputEntry);
    }
  }

  getLogDetails(outputEntry) {
    const record = outputEntry.logs.reduce(function (record, entry) {
      record.requestId = entry.requestId;

      if (entry.response) {
        const url = _url.default.parse(entry.response.url);

        record.name = `${_lodash.default.last(url.pathname.split('/'))}${url.search ? `?${url.search}` : ''}` || url.host;
        record.status = entry.response.status;

        if (entry.response.timing) {
          record.time = entry.response.timing.receiveHeadersEnd || entry.response.timing.responseStart || 0;
        }

        record.source = entry.response.source;
      }

      if (entry.type) {
        record.type = entry.type;
      }

      if (entry.initiator) {
        record.initiator = entry.initiator;
      }

      if (entry.metrics) {
        record.size = entry.metrics.responseBodyBytesReceived || 0;
      }

      if (entry.errorText) {
        record.errorText = entry.errorText;
        record.cancelled = entry.canceled;
      }

      return record;
    }, {});
    return record;
  }

  printLogLine(outputEntry) {
    const {
      requestId,
      name,
      status,
      type,
      initiator = {},
      size = 0,
      time = 0,
      source,
      errorText,
      cancelled = false
    } = this.getLogDetails(outputEntry);
    this.log.debug(`Network event:`);
    this.log.debug(`  Id: ${requestId}`);
    this.log.debug(`  Name: ${name}`);
    this.log.debug(`  Status: ${status}`);
    this.log.debug(`  Type: ${type}`);
    this.log.debug(`  Initiator: ${initiator.type}`);

    for (const line of initiator.stackTrace || []) {
      const functionName = line.functionName || '(anonymous)';
      const url = !line.url || line.url === '[native code]' ? '' : `@${_lodash.default.last((_url.default.parse(line.url).pathname || '').split('/'))}:${line.lineNumber}`;
      this.log.debug(`    ${_lodash.default.truncate(functionName, {
        length: 20
      }).padEnd(21)} ${url}`);
    }

    const sizeStr = source.includes('cache') ? ` (from ${source.replace('-', ' ')})` : `${size}B`;
    this.log.debug(`  Size: ${sizeStr}`);
    this.log.debug(`  Time: ${Math.round(time)}ms`);

    if (errorText) {
      this.log.debug(`  Error: ${errorText}`);
    }

    if (_appiumSupport.util.hasValue(cancelled)) {
      this.log.debug(`  Cancelled: ${cancelled}`);
    }
  }

  async getLogs() {
    const logs = await super.getLogs();
    return logs.map(function (entry) {
      return Object.assign({}, entry, {
        level: 'INFO',
        timestamp: Date.now(),
        message: JSON.stringify(entry)
      });
    });
  }

}

exports.SafariNetworkLog = SafariNetworkLog;
var _default = SafariNetworkLog;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UtbG9nL3NhZmFyaS1uZXR3b3JrLWxvZy5qcyJdLCJuYW1lcyI6WyJTYWZhcmlOZXR3b3JrTG9nIiwiUm90YXRpbmdMb2ciLCJjb25zdHJ1Y3RvciIsInNob3dMb2dzIiwiZ2V0RW50cnkiLCJyZXF1ZXN0SWQiLCJvdXRwdXRFbnRyeSIsImxvZ3MiLCJsZW5ndGgiLCJNQVhfTE9HX0VOVFJJRVNfQ09VTlQiLCJlbnRyeSIsInNoaWZ0IiwicHVzaCIsImxvZ0lkeFNpbmNlTGFzdFJlcXVlc3QiLCJpIiwic3BsaWNlIiwiYWRkTG9nTGluZSIsIm1ldGhvZCIsIm91dCIsImlzQ2FwdHVyaW5nIiwiaW5jbHVkZXMiLCJwcmludExvZ0xpbmUiLCJnZXRMb2dEZXRhaWxzIiwicmVjb3JkIiwicmVkdWNlIiwicmVzcG9uc2UiLCJ1cmwiLCJVUkwiLCJwYXJzZSIsIm5hbWUiLCJfIiwibGFzdCIsInBhdGhuYW1lIiwic3BsaXQiLCJzZWFyY2giLCJob3N0Iiwic3RhdHVzIiwidGltaW5nIiwidGltZSIsInJlY2VpdmVIZWFkZXJzRW5kIiwicmVzcG9uc2VTdGFydCIsInNvdXJjZSIsInR5cGUiLCJpbml0aWF0b3IiLCJtZXRyaWNzIiwic2l6ZSIsInJlc3BvbnNlQm9keUJ5dGVzUmVjZWl2ZWQiLCJlcnJvclRleHQiLCJjYW5jZWxsZWQiLCJjYW5jZWxlZCIsImxvZyIsImRlYnVnIiwibGluZSIsInN0YWNrVHJhY2UiLCJmdW5jdGlvbk5hbWUiLCJsaW5lTnVtYmVyIiwidHJ1bmNhdGUiLCJwYWRFbmQiLCJzaXplU3RyIiwicmVwbGFjZSIsIk1hdGgiLCJyb3VuZCIsInV0aWwiLCJoYXNWYWx1ZSIsImdldExvZ3MiLCJtYXAiLCJPYmplY3QiLCJhc3NpZ24iLCJsZXZlbCIsInRpbWVzdGFtcCIsIkRhdGUiLCJub3ciLCJtZXNzYWdlIiwiSlNPTiIsInN0cmluZ2lmeSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFD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SUFBSSxDQUFDMEQsR0FBTCxDQUFTLFVBQVV2RCxLQUFWLEVBQWlCO0FBQy9CLGFBQU93RCxNQUFNLENBQUNDLE1BQVAsQ0FBYyxFQUFkLEVBQWtCekQsS0FBbEIsRUFBeUI7QUFDOUIwRCxRQUFBQSxLQUFLLEVBQUUsTUFEdUI7QUFFOUJDLFFBQUFBLFNBQVMsRUFBRUMsSUFBSSxDQUFDQyxHQUFMLEVBRm1CO0FBRzlCQyxRQUFBQSxPQUFPLEVBQUVDLElBQUksQ0FBQ0MsU0FBTCxDQUFlaEUsS0FBZjtBQUhxQixPQUF6QixDQUFQO0FBS0QsS0FOTSxDQUFQO0FBT0Q7O0FBdEx3Qzs7O2VBMEw1QlYsZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IFVSTCBmcm9tICd1cmwnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IFJvdGF0aW5nTG9nLCBNQVhfTE9HX0VOVFJJRVNfQ09VTlQgfSBmcm9tICcuL3JvdGF0aW5nLWxvZyc7XG5cblxuY2xhc3MgU2FmYXJpTmV0d29ya0xvZyBleHRlbmRzIFJvdGF0aW5nTG9nIHtcbiAgY29uc3RydWN0b3IgKHNob3dMb2dzKSB7XG4gICAgc3VwZXIoc2hvd0xvZ3MsICdTYWZhcmlOZXR3b3JrJyk7XG4gIH1cblxuICBnZXRFbnRyeSAocmVxdWVzdElkKSB7XG4gICAgbGV0IG91dHB1dEVudHJ5O1xuICAgIHdoaWxlICh0aGlzLmxvZ3MubGVuZ3RoID49IE1BWF9MT0dfRU5UUklFU19DT1VOVCkge1xuICAgICAgLy8gcHVsbCB0aGUgZmlyc3QgZW50cnksIHdoaWNoIGlzIHRoZSBvbGRlc3RcbiAgICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5sb2dzLnNoaWZ0KCk7XG4gICAgICBpZiAoZW50cnkgJiYgZW50cnkucmVxdWVzdElkID09PSByZXF1ZXN0SWQpIHtcbiAgICAgICAgLy8gd2UgYXJlIGFkZGluZyB0byBhbiBleGlzdGluZyBlbnRyeSwgYW5kIGl0IHdhcyBhbG1vc3QgcmVtb3ZlZFxuICAgICAgICAvLyBhZGQgdG8gdGhlIGVuZCBvZiB0aGUgbGlzdCBhbmQgdHJ5IGFnYWluXG4gICAgICAgIG91dHB1dEVudHJ5ID0gZW50cnk7XG4gICAgICAgIHRoaXMubG9ncy5wdXNoKG91dHB1dEVudHJ5KTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICAvLyB3ZSd2ZSByZW1vdmVkIGFuIGVsZW1lbnQsIHNvIHRoZSBjb3VudCBpcyBkb3duIG9uZVxuICAgICAgaWYgKHRoaXMubG9nSWR4U2luY2VMYXN0UmVxdWVzdCA+IDApIHtcbiAgICAgICAgdGhpcy5sb2dJZHhTaW5jZUxhc3RSZXF1ZXN0LS07XG4gICAgICB9XG4gICAgfVxuXG5cbiAgICBpZiAoIW91dHB1dEVudHJ5KSB7XG4gICAgICAvLyB3ZSBkbyBub3QgeWVzIGhhdmUgYW4gZW50cnkgdG8gYXNzb2NpYXRlIHRoaXMgYml0IG9mIG91dHB1dCB3aXRoXG4gICAgICAvLyBtb3N0IGxpa2VseSB0aGUgZW50cnkgd2lsbCBiZSBhdCB0aGUgZW5kIG9mIHRoZSBsaXN0LCBzbyBzdGFydCB0aGVyZVxuICAgICAgZm9yIChsZXQgaSA9IHRoaXMubG9ncy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICBpZiAodGhpcy5sb2dzW2ldLnJlcXVlc3RJZCA9PT0gcmVxdWVzdElkKSB7XG4gICAgICAgICAgLy8gZm91bmQgaXQhXG4gICAgICAgICAgb3V0cHV0RW50cnkgPSB0aGlzLmxvZ3NbaV07XG4gICAgICAgICAgLy8gdGhpcyBpcyBub3cgdGhlIG1vc3QgY3VycmVudCBlbnRyeSwgc28gcmVtb3ZlIGl0IGZyb20gdGhlIGxpc3RcbiAgICAgICAgICAvLyB0byBiZSBhZGRlZCB0byB0aGUgZW5kIGJlbG93XG4gICAgICAgICAgdGhpcy5sb2dzLnNwbGljZShpLCAxKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBub3RoaW5nIGhhcyBiZWVuIGZvdW5kLCBzbyBjcmVhdGUgYSBuZXcgZW50cnlcbiAgICAgIGlmICghb3V0cHV0RW50cnkpIHtcbiAgICAgICAgb3V0cHV0RW50cnkgPSB7XG4gICAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICAgIGxvZ3M6IFtdLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBmaW5hbGx5LCBhZGQgdGhlIGVudHJ5IHRvIHRoZSBlbmQgb2YgdGhlIGxpc3RcbiAgICAgIHRoaXMubG9ncy5wdXNoKG91dHB1dEVudHJ5KTtcbiAgICB9XG5cbiAgICByZXR1cm4gb3V0cHV0RW50cnk7XG4gIH1cblxuICBhZGRMb2dMaW5lIChtZXRob2QsIG91dCkge1xuICAgIGlmICghdGhpcy5pc0NhcHR1cmluZyAmJiAhdGhpcy5zaG93TG9ncykge1xuICAgICAgLy8gbmVpdGhlciBjYXB0dXJpbmcgbm9yIGRpc3BsYXlpbmcsIHNvIGRvIG5vdGhpbmdcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoWydOZXR3b3JrLmRhdGFSZWNlaXZlZCddLmluY2x1ZGVzKG1ldGhvZCkpIHtcbiAgICAgIC8vIHN0YXR1cyB1cGRhdGUsIG5vIG5lZWQgdG8gaGFuZGxlXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gZXZlbnRzIHdlIGNhcmUgYWJvdXQ6XG4gICAgLy8gICBOZXR3b3JrLnJlcXVlc3RXaWxsQmVTZW50XG4gICAgLy8gICBOZXR3b3JrLnJlc3BvbnNlUmVjZWl2ZWRcbiAgICAvLyAgIE5ldHdvcmsubG9hZGluZ0ZpbmlzaGVkXG4gICAgLy8gICBOZXR3b3JrLmxvYWRpbmdGYWlsZWRcblxuICAgIGNvbnN0IG91dHB1dEVudHJ5ID0gdGhpcy5nZXRFbnRyeShvdXQucmVxdWVzdElkKTtcbiAgICBpZiAodGhpcy5pc0NhcHR1cmluZykge1xuICAgICAgLy8gbm93IGFkZCB0aGUgb3V0cHV0IHdlIGp1c3QgcmVjZWl2ZWQgdG8gdGhlIGxvZ3MgZm9yIHRoaXMgcGFydGljdWxhciBlbnRyeVxuICAgICAgb3V0cHV0RW50cnkubG9ncyA9IG91dHB1dEVudHJ5LmxvZ3MgfHwgW107XG5cbiAgICAgIG91dHB1dEVudHJ5LmxvZ3MucHVzaChvdXQpO1xuICAgIH1cblxuICAgIC8vIGlmIHdlIGFyZSBub3QgZGlzcGxheWluZyB0aGUgbG9ncyxcbiAgICAvLyBvciB3ZSBhcmUgbm90IGZpbmlzaGVkIGdldHRpbmcgZXZlbnRzIGZvciB0aGlzIG5ldHdvcmsgY2FsbCxcbiAgICAvLyB3ZSBhcmUgZG9uZVxuICAgIGlmICghdGhpcy5zaG93TG9ncykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChtZXRob2QgPT09ICdOZXR3b3JrLmxvYWRpbmdGaW5pc2hlZCcgfHwgbWV0aG9kID09PSAnTmV0d29yay5sb2FkaW5nRmFpbGVkJykge1xuICAgICAgdGhpcy5wcmludExvZ0xpbmUob3V0cHV0RW50cnkpO1xuICAgIH1cbiAgfVxuXG4gIGdldExvZ0RldGFpbHMgKG91dHB1dEVudHJ5KSB7XG4gICAgLy8gZXh0cmFjdCB0aGUgZGF0YVxuICAgIGNvbnN0IHJlY29yZCA9IG91dHB1dEVudHJ5LmxvZ3MucmVkdWNlKGZ1bmN0aW9uIChyZWNvcmQsIGVudHJ5KSB7XG4gICAgICByZWNvcmQucmVxdWVzdElkID0gZW50cnkucmVxdWVzdElkO1xuICAgICAgaWYgKGVudHJ5LnJlc3BvbnNlKSB7XG4gICAgICAgIGNvbnN0IHVybCA9IFVSTC5wYXJzZShlbnRyeS5yZXNwb25zZS51cmwpO1xuICAgICAgICAvLyBnZXQgdGhlIGxhc3QgcGFydCBvZiB0aGUgdXJsLCBhbG9uZyB3aXRoIHRoZSBxdWVyeSBzdHJpbmcsIGlmIHBvc3NpYmxlXG4gICAgICAgIHJlY29yZC5uYW1lID0gYCR7Xy5sYXN0KHVybC5wYXRobmFtZS5zcGxpdCgnLycpKX0ke3VybC5zZWFyY2ggPyBgPyR7dXJsLnNlYXJjaH1gIDogJyd9YCB8fCB1cmwuaG9zdDtcbiAgICAgICAgcmVjb3JkLnN0YXR1cyA9IGVudHJ5LnJlc3BvbnNlLnN0YXR1cztcbiAgICAgICAgaWYgKGVudHJ5LnJlc3BvbnNlLnRpbWluZykge1xuICAgICAgICAgIHJlY29yZC50aW1lID0gZW50cnkucmVzcG9uc2UudGltaW5nLnJlY2VpdmVIZWFkZXJzRW5kXG4gICAgICAgICAgICB8fCBlbnRyeS5yZXNwb25zZS50aW1pbmcucmVzcG9uc2VTdGFydFxuICAgICAgICAgICAgfHwgMDtcbiAgICAgICAgfVxuICAgICAgICByZWNvcmQuc291cmNlID0gZW50cnkucmVzcG9uc2Uuc291cmNlO1xuICAgICAgfVxuICAgICAgaWYgKGVudHJ5LnR5cGUpIHtcbiAgICAgICAgcmVjb3JkLnR5cGUgPSBlbnRyeS50eXBlO1xuICAgICAgfVxuICAgICAgaWYgKGVudHJ5LmluaXRpYXRvcikge1xuICAgICAgICByZWNvcmQuaW5pdGlhdG9yID0gZW50cnkuaW5pdGlhdG9yO1xuICAgICAgfVxuICAgICAgaWYgKGVudHJ5Lm1ldHJpY3MpIHtcbiAgICAgICAgLy8gU2FmYXJpIGhhcyBhIGBtZXRyaWNzYCBvYmplY3Qgb24gaXQncyBgTmV0d29yay5sb2FkaW5nRmluaXNoZWRgIGV2ZW50XG4gICAgICAgIHJlY29yZC5zaXplID0gZW50cnkubWV0cmljcy5yZXNwb25zZUJvZHlCeXRlc1JlY2VpdmVkIHx8IDA7XG4gICAgICB9XG4gICAgICBpZiAoZW50cnkuZXJyb3JUZXh0KSB7XG4gICAgICAgIHJlY29yZC5lcnJvclRleHQgPSBlbnRyeS5lcnJvclRleHQ7XG4gICAgICAgIC8vIFdoZW4gYSBuZXR3b3JrIGNhbGwgaXMgY2FuY2VsbGVkLCBTYWZhcmkgcmV0dXJucyBgY2FuY2VsbGVkYCBhcyBlcnJvciB0ZXh0XG4gICAgICAgIC8vIGJ1dCBoYXMgYSBib29sZWFuIGBjYW5jZWxlZGAuIE5vcm1hbGl6ZSB0aGUgdHdvIHNwZWxsaW5ncyBpbiBmYXZvciBvZlxuICAgICAgICAvLyB0aGUgdGV4dCwgd2hpY2ggd2lsbCBhbHNvIGJlIGRpc3BsYXllZFxuICAgICAgICByZWNvcmQuY2FuY2VsbGVkID0gZW50cnkuY2FuY2VsZWQ7XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVjb3JkO1xuICAgIH0sIHt9KTtcblxuICAgIHJldHVybiByZWNvcmQ7XG4gIH1cblxuICBwcmludExvZ0xpbmUgKG91dHB1dEVudHJ5KSB7XG4gICAgY29uc3Qge1xuICAgICAgcmVxdWVzdElkLFxuICAgICAgbmFtZSxcbiAgICAgIHN0YXR1cyxcbiAgICAgIHR5cGUsXG4gICAgICBpbml0aWF0b3IgPSB7fSxcbiAgICAgIHNpemUgPSAwLFxuICAgICAgdGltZSA9IDAsXG4gICAgICBzb3VyY2UsXG4gICAgICBlcnJvclRleHQsXG4gICAgICBjYW5jZWxsZWQgPSBmYWxzZSxcbiAgICB9ID0gdGhpcy5nZXRMb2dEZXRhaWxzKG91dHB1dEVudHJ5KTtcblxuICAgIC8vIHByaW50IG91dCB0aGUgcmVjb3JkLCBmb3JtYXR0ZWQgYXBwcm9wcmlhdGVseVxuICAgIHRoaXMubG9nLmRlYnVnKGBOZXR3b3JrIGV2ZW50OmApO1xuICAgIHRoaXMubG9nLmRlYnVnKGAgIElkOiAke3JlcXVlc3RJZH1gKTtcbiAgICB0aGlzLmxvZy5kZWJ1ZyhgICBOYW1lOiAke25hbWV9YCk7XG4gICAgdGhpcy5sb2cuZGVidWcoYCAgU3RhdHVzOiAke3N0YXR1c31gKTtcbiAgICB0aGlzLmxvZy5kZWJ1ZyhgICBUeXBlOiAke3R5cGV9YCk7XG4gICAgdGhpcy5sb2cuZGVidWcoYCAgSW5pdGlhdG9yOiAke2luaXRpYXRvci50eXBlfWApO1xuICAgIGZvciAoY29uc3QgbGluZSBvZiAoaW5pdGlhdG9yLnN0YWNrVHJhY2UgfHwgW10pKSB7XG4gICAgICBjb25zdCBmdW5jdGlvbk5hbWUgPSBsaW5lLmZ1bmN0aW9uTmFtZSB8fCAnKGFub255bW91cyknO1xuXG4gICAgICBjb25zdCB1cmwgPSAoIWxpbmUudXJsIHx8IGxpbmUudXJsID09PSAnW25hdGl2ZSBjb2RlXScpXG4gICAgICAgID8gJydcbiAgICAgICAgOiBgQCR7Xy5sYXN0KChVUkwucGFyc2UobGluZS51cmwpLnBhdGhuYW1lIHx8ICcnKS5zcGxpdCgnLycpKX06JHtsaW5lLmxpbmVOdW1iZXJ9YDtcbiAgICAgIHRoaXMubG9nLmRlYnVnKGAgICAgJHtfLnRydW5jYXRlKGZ1bmN0aW9uTmFtZSwge2xlbmd0aDogMjB9KS5wYWRFbmQoMjEpfSAke3VybH1gKTtcbiAgICB9XG4gICAgLy8gZ2V0IGBtZW1vcnktY2FjaGVgIG9yIGBkaXNrLWNhY2hlYCwgZXRjLiwgcmlnaHRcbiAgICBjb25zdCBzaXplU3RyID0gc291cmNlLmluY2x1ZGVzKCdjYWNoZScpID8gYCAoZnJvbSAke3NvdXJjZS5yZXBsYWNlKCctJywgJyAnKX0pYCA6IGAke3NpemV9QmA7XG4gICAgdGhpcy5sb2cuZGVidWcoYCAgU2l6ZTogJHtzaXplU3RyfWApO1xuICAgIHRoaXMubG9nLmRlYnVnKGAgIFRpbWU6ICR7TWF0aC5yb3VuZCh0aW1lKX1tc2ApO1xuICAgIGlmIChlcnJvclRleHQpIHtcbiAgICAgIHRoaXMubG9nLmRlYnVnKGAgIEVycm9yOiAke2Vycm9yVGV4dH1gKTtcbiAgICB9XG4gICAgaWYgKHV0aWwuaGFzVmFsdWUoY2FuY2VsbGVkKSkge1xuICAgICAgdGhpcy5sb2cuZGVidWcoYCAgQ2FuY2VsbGVkOiAke2NhbmNlbGxlZH1gKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRMb2dzICgpIHtcbiAgICBjb25zdCBsb2dzID0gYXdhaXQgc3VwZXIuZ2V0TG9ncygpO1xuICAgIC8vIGluIG9yZGVyIHRvIHNhdGlzZnkgY2VydGFpbiBjbGllbnRzLCB3ZSBuZWVkIHRvIGhhdmUgYSBiYXNpYyBzdHJ1Y3R1cmVcbiAgICAvLyB0byB0aGUgcmVzdWx0cywgd2l0aCBgbGV2ZWxgLCBgdGltZXN0YW1wYCwgYW5kIGBtZXNzYWdlYCwgd2hpY2ggaXNcbiAgICAvLyBhbGwgdGhlIGluZm9ybWF0aW9uIHN0cmluZ2lmaWVkXG4gICAgcmV0dXJuIGxvZ3MubWFwKGZ1bmN0aW9uIChlbnRyeSkge1xuICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIGVudHJ5LCB7XG4gICAgICAgIGxldmVsOiAnSU5GTycsXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgICAgbWVzc2FnZTogSlNPTi5zdHJpbmdpZnkoZW50cnkpLFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IHsgU2FmYXJpTmV0d29ya0xvZyB9O1xuZXhwb3J0IGRlZmF1bHQgU2FmYXJpTmV0d29ya0xvZztcbiJdLCJmaWxlIjoibGliL2RldmljZS1sb2cvc2FmYXJpLW5ldHdvcmstbG9nLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
