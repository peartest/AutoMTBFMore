"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.CUSTOM_STRATEGY = exports.IMAGE_STRATEGY = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

var _2 = require("../../..");

var _images = require("./images");

var _protocol = require("../../protocol/protocol");

var _imageElement = require("../image-element");

const commands = {},
      helpers = {},
      extensions = {};
exports.helpers = helpers;
exports.commands = commands;
const IMAGE_STRATEGY = "-image";
exports.IMAGE_STRATEGY = IMAGE_STRATEGY;
const CUSTOM_STRATEGY = "-custom";
exports.CUSTOM_STRATEGY = CUSTOM_STRATEGY;

helpers.findElOrElsWithProcessing = async function (strategy, selector, mult, context) {
  this.validateLocatorStrategy(strategy);

  try {
    return await this.findElOrEls(strategy, selector, mult, context);
  } catch (err) {
    if (this.opts.printPageSourceOnFindFailure) {
      const src = await this.getPageSource();

      _logger.default.debug(`Error finding element${mult ? 's' : ''}: ${err.message}`);

      _logger.default.debug(`Page source requested through 'printPageSourceOnFindFailure':`);

      _logger.default.debug(src);
    }

    throw err;
  }
};

commands.findElement = async function (strategy, selector) {
  if (strategy === IMAGE_STRATEGY) {
    return await this.findByImage(selector, {
      multiple: false
    });
  } else if (strategy === CUSTOM_STRATEGY) {
    return await this.findByCustom(selector, false);
  }

  return await this.findElOrElsWithProcessing(strategy, selector, false);
};

commands.findElements = async function (strategy, selector) {
  if (strategy === IMAGE_STRATEGY) {
    return await this.findByImage(selector, {
      multiple: true
    });
  } else if (strategy === CUSTOM_STRATEGY) {
    return await this.findByCustom(selector, true);
  }

  return await this.findElOrElsWithProcessing(strategy, selector, true);
};

commands.findElementFromElement = async function (strategy, selector, elementId) {
  return await this.findElOrElsWithProcessing(strategy, selector, false, elementId);
};

commands.findElementsFromElement = async function (strategy, selector, elementId) {
  return await this.findElOrElsWithProcessing(strategy, selector, true, elementId);
};

commands.findByCustom = async function (selector, multiple) {
  const plugins = this.opts.customFindModules;

  if (!plugins) {
    throw new Error("Finding an element using a plugin is currently an " + "incubating feature. To use it you must manually install one or more " + "plugin modules in a way that they can be required by Appium, for " + "example installing them from the Appium directory, installing them " + "globally, or installing them elsewhere and passing an absolute path as " + "the capability. Then construct an object where the key is the shortcut " + "name for this plugin and the value is the module name or absolute path, " + "for example: {\"p1\": \"my-find-plugin\"}, and pass this in as the " + "'customFindModules' capability.");
  }

  if (!_lodash.default.isPlainObject(plugins)) {
    throw new Error("Invalid format for the 'customFindModules' capability. " + "It should be an object with keys corresponding to the short names and " + "values corresponding to the full names of the element finding plugins");
  }

  let [plugin, realSelector] = selector.split(":");

  if (_lodash.default.size(plugins) > 1 && !realSelector) {
    throw new Error(`Multiple element finding plugins were registered ` + `(${_lodash.default.keys(plugins)}), but your selector did not indicate which plugin ` + `to use. Ensure you put the short name of the plugin followed by ':' as ` + `the initial part of the selector string.`);
  }

  if (_lodash.default.size(plugins) === 1 && !realSelector) {
    realSelector = plugin;
    plugin = _lodash.default.keys(plugins)[0];
  }

  if (!plugins[plugin]) {
    throw new Error(`Selector specified use of element finding plugin ` + `'${plugin}' but it was not registered in the 'customFindModules' ` + `capability.`);
  }

  let finder;

  try {
    _logger.default.debug(`Find plugin '${plugin}' requested; will attempt to use it ` + `from '${plugins[plugin]}'`);

    finder = require(plugins[plugin]);
  } catch (err) {
    throw new Error(`Could not load your custom find module '${plugin}'. Did ` + `you put it somewhere Appium can 'require' it? Original error: ${err}`);
  }

  if (!finder || !_lodash.default.isFunction(finder.find)) {
    throw new Error("Your custom find module did not appear to be constructed " + "correctly. It needs to export an object with a `find` method.");
  }

  const customFinderLog = _appiumSupport.logger.getLogger(plugin);

  let elements;

  const condition = async () => {
    elements = await finder.find(this, customFinderLog, realSelector, multiple);

    if (!_lodash.default.isEmpty(elements) || multiple) {
      return true;
    }

    return false;
  };

  try {
    await this.implicitWaitForCondition(condition);
  } catch (err) {
    if (err.message.match(/Condition unmet/)) {
      throw new _2.errors.NoSuchElementError();
    }

    throw err;
  }

  return multiple ? elements : elements[0];
};

helpers.findByImage = async function (b64Template, {
  shouldCheckStaleness = false,
  multiple = false
}) {
  const {
    imageMatchThreshold: threshold,
    fixImageTemplateSize
  } = this.settings.getSettings();

  _logger.default.info(`Finding image element with match threshold ${threshold}`);

  if (!this.getWindowSize) {
    throw new Error("This driver does not support the required 'getWindowSize' command");
  }

  const {
    width: screenWidth,
    height: screenHeight
  } = await this.getWindowSize();

  if (fixImageTemplateSize) {
    b64Template = await this.ensureTemplateSize(b64Template, screenWidth, screenHeight);
  }

  let rect = null;

  const condition = async () => {
    try {
      let b64Screenshot = await this.getScreenshotForImageFind(screenWidth, screenHeight);
      rect = (await this.compareImages(_images.MATCH_TEMPLATE_MODE, b64Screenshot, b64Template, {
        threshold
      })).rect;
      return true;
    } catch (err) {
      if (err.message.match(/Cannot find any occurrences/)) {
        return false;
      }

      throw err;
    }
  };

  try {
    await this.implicitWaitForCondition(condition);
  } catch (err) {
    if (!err.message.match(/Condition unmet/)) {
      throw err;
    }
  }

  if (!rect) {
    if (multiple) {
      return [];
    }

    throw new _2.errors.NoSuchElementError();
  }

  _logger.default.info(`Image template matched: ${JSON.stringify(rect)}`);

  const imgEl = new _imageElement.ImageElement(b64Template, rect);

  if (shouldCheckStaleness) {
    return imgEl;
  }

  this._imgElCache.set(imgEl.id, imgEl);

  const protoKey = this.isW3CProtocol() ? _protocol.W3C_ELEMENT_KEY : _protocol.MJSONWP_ELEMENT_KEY;
  const protocolEl = imgEl.asElement(protoKey);
  return multiple ? [protocolEl] : protocolEl;
};

helpers.ensureTemplateSize = async function (b64Template, screenWidth, screenHeight) {
  let imgObj = await _appiumSupport.imageUtil.getJimpImage(b64Template);
  let {
    width: tplWidth,
    height: tplHeight
  } = imgObj.bitmap;

  if (tplWidth <= screenWidth && tplHeight <= screenHeight) {
    return b64Template;
  }

  imgObj = imgObj.scaleToFit(screenWidth, screenHeight);
  return (await imgObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
};

helpers.getScreenshotForImageFind = async function (screenWidth, screenHeight) {
  if (!this.getScreenshot) {
    throw new Error("This driver does not support the required 'getScreenshot' command");
  }

  let b64Screenshot = await this.getScreenshot();

  if (!this.settings.getSettings().fixImageFindScreenshotDims) {
    _logger.default.info(`Not verifying screenshot dimensions match screen`);

    return b64Screenshot;
  }

  _logger.default.info('Verifying screenshot size and aspect ratio');

  let imgObj = await _appiumSupport.imageUtil.getJimpImage(b64Screenshot);
  let {
    width: shotWidth,
    height: shotHeight
  } = imgObj.bitmap;

  if (screenWidth === shotWidth && screenHeight === shotHeight) {
    _logger.default.info('Screenshot size matched screen size');

    return b64Screenshot;
  }

  const screenAR = screenWidth / screenHeight;
  const shotAR = shotWidth / shotHeight;

  if (screenAR === shotAR) {
    _logger.default.info('Screenshot aspect ratio matched screen aspect ratio');
  } else {
    _logger.default.warn(`When trying to find an element, determined that the screen ` + `aspect ratio and screenshot aspect ratio are different. Screen ` + `is ${screenWidth}x${screenHeight} whereas screenshot is ` + `${shotWidth}x${shotHeight}.`);

    shotWidth = shotWidth / (shotAR / screenAR);

    _logger.default.warn(`Resizing screenshot to ${shotWidth}x${shotHeight} to match ` + `screen aspect ratio so that image element coordinates have a ` + `greater chance of being correct.`);

    imgObj = imgObj.resize(shotWidth, shotHeight);
  }

  if (screenWidth !== shotWidth) {
    _logger.default.info(`Scaling screenshot from ${shotWidth}x${shotHeight} to match ` + `screen at ${screenWidth}x${screenHeight}`);

    imgObj = imgObj.resize(screenWidth, screenHeight);
  }

  return (await imgObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL2ZpbmQuanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJoZWxwZXJzIiwiZXh0ZW5zaW9ucyIsIklNQUdFX1NUUkFURUdZIiwiQ1VTVE9NX1NUUkFURUdZIiwiZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyIsInN0cmF0ZWd5Iiwic2VsZWN0b3IiLCJtdWx0IiwiY29udGV4dCIsInZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5IiwiZmluZEVsT3JFbHMiLCJlcnIiLCJvcHRzIiwicHJpbnRQYWdlU291cmNlT25GaW5kRmFpbHVyZSIsInNyYyIsImdldFBhZ2VTb3VyY2UiLCJsb2ciLCJkZWJ1ZyIsIm1lc3NhZ2UiLCJmaW5kRWxlbWVudCIsImZpbmRCeUltYWdlIiwibXVsdGlwbGUiLCJmaW5kQnlDdXN0b20iLCJmaW5kRWxlbWVudHMiLCJmaW5kRWxlbWVudEZyb21FbGVtZW50IiwiZWxlbWVudElkIiwiZmluZEVsZW1lbnRzRnJvbUVsZW1lbnQiLCJwbHVnaW5zIiwiY3VzdG9tRmluZE1vZHVsZXMiLCJFcnJvciIsIl8iLCJpc1BsYWluT2JqZWN0IiwicGx1Z2luIiwicmVhbFNlbGVjdG9yIiwic3BsaXQiLCJzaXplIiwia2V5cyIsImZpbmRlciIsInJlcXVpcmUiLCJpc0Z1bmN0aW9uIiwiZmluZCIsImN1c3RvbUZpbmRlckxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsImVsZW1lbnRzIiwiY29uZGl0aW9uIiwiaXNFbXB0eSIsImltcGxpY2l0V2FpdEZvckNvbmRpdGlvbiIsIm1hdGNoIiwiZXJyb3JzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwiYjY0VGVtcGxhdGUiLCJzaG91bGRDaGVja1N0YWxlbmVzcyIsImltYWdlTWF0Y2hUaHJlc2hvbGQiLCJ0aHJlc2hvbGQiLCJmaXhJbWFnZVRlbXBsYXRlU2l6ZSIsInNldHRpbmdzIiwiZ2V0U2V0dGluZ3MiLCJpbmZvIiwiZ2V0V2luZG93U2l6ZSIsIndpZHRoIiwic2NyZWVuV2lkdGgiLCJoZWlnaHQiLCJzY3JlZW5IZWlnaHQiLCJlbnN1cmVUZW1wbGF0ZVNpemUiLCJyZWN0IiwiYjY0U2NyZWVuc2hvdCIsImdldFNjcmVlbnNob3RGb3JJbWFnZUZpbmQiLCJjb21wYXJlSW1hZ2VzIiwiTUFUQ0hfVEVNUExBVEVfTU9ERSIsIkpTT04iLCJzdHJpbmdpZnkiLCJpbWdFbCIsIkltYWdlRWxlbWVudCIsIl9pbWdFbENhY2hlIiwic2V0IiwiaWQiLCJwcm90b0tleSIsImlzVzNDUHJvdG9jb2wiLCJXM0NfRUxFTUVOVF9LRVkiLCJNSlNPTldQX0VMRU1FTlRfS0VZIiwicHJvdG9jb2xFbCIsImFzRWxlbWVudCIsImltZ09iaiIsImltYWdlVXRpbCIsImdldEppbXBJbWFnZSIsInRwbFdpZHRoIiwidHBsSGVpZ2h0IiwiYml0bWFwIiwic2NhbGVUb0ZpdCIsImdldEJ1ZmZlciIsIk1JTUVfUE5HIiwidG9TdHJpbmciLCJnZXRTY3JlZW5zaG90IiwiZml4SW1hZ2VGaW5kU2NyZWVuc2hvdERpbXMiLCJzaG90V2lkdGgiLCJzaG90SGVpZ2h0Iiwic2NyZWVuQVIiLCJzaG90QVIiLCJ3YXJuIiwicmVzaXplIiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLFFBQVEsR0FBRyxFQUFqQjtBQUFBLE1BQXFCQyxPQUFPLEdBQUcsRUFBL0I7QUFBQSxNQUFtQ0MsVUFBVSxHQUFHLEVBQWhEOzs7QUFFQSxNQUFNQyxjQUFjLEdBQUcsUUFBdkI7O0FBQ0EsTUFBTUMsZUFBZSxHQUFHLFNBQXhCOzs7QUFjQUgsT0FBTyxDQUFDSSx5QkFBUixHQUFvQyxnQkFBZ0JDLFFBQWhCLEVBQTBCQyxRQUExQixFQUFvQ0MsSUFBcEMsRUFBMENDLE9BQTFDLEVBQW1EO0FBQ3JGLE9BQUtDLHVCQUFMLENBQTZCSixRQUE3Qjs7QUFDQSxNQUFJO0FBQ0YsV0FBTyxNQUFNLEtBQUtL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QUF5QjtBQUN2QmxGLG9CQUFJMEMsSUFBSixDQUFTLHFEQUFUO0FBQ0QsR0FGRCxNQUVPO0FBQ0wxQyxvQkFBSW1GLElBQUosQ0FBVSw2REFBRCxHQUNDLGlFQURELEdBRUMsTUFBS3RDLFdBQVksSUFBR0UsWUFBYSx5QkFGbEMsR0FHQyxHQUFFZ0MsU0FBVSxJQUFHQyxVQUFXLEdBSHBDOztBQUlBRCxJQUFBQSxTQUFTLEdBQUdBLFNBQVMsSUFBSUcsTUFBTSxHQUFHRCxRQUFiLENBQXJCOztBQUNBakYsb0JBQUltRixJQUFKLENBQVUsMEJBQXlCSixTQUFVLElBQUdDLFVBQVcsWUFBbEQsR0FDQywrREFERCxHQUVDLGtDQUZWOztBQUdBYixJQUFBQSxNQUFNLEdBQUdBLE1BQU0sQ0FBQ2lCLE1BQVAsQ0FBY0wsU0FBZCxFQUF5QkMsVUFBekIsQ0FBVDtBQUNEOztBQUlELE1BQUluQyxXQUFXLEtBQUtrQyxTQUFwQixFQUErQjtBQUM3Qi9FLG9CQUFJMEMsSUFBSixDQUFVLDJCQUEwQnFDLFNBQVUsSUFBR0MsVUFBVyxZQUFuRCxHQUNDLGFBQVluQyxXQUFZLElBQUdFLFlBQWEsRUFEbEQ7O0FBRUFvQixJQUFBQSxNQUFNLEdBQUdBLE1BQU0sQ0FBQ2lCLE1BQVAsQ0FBY3ZDLFdBQWQsRUFBMkJFLFlBQTNCLENBQVQ7QUFDRDs7QUFFRCxTQUFPLENBQUMsTUFBTW9CLE1BQU0sQ0FBQ08sU0FBUCxDQUFpQk4seUJBQVVPLFFBQTNCLENBQVAsRUFBNkNDLFFBQTdDLENBQXNELFFBQXRELENBQVA7QUFDRCxDQTVERDs7QUErREFTLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjckcsVUFBZCxFQUEwQkYsUUFBMUIsRUFBb0NDLE9BQXBDO2VBRWVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBsb2dnZXIsIGltYWdlVXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICcuLi8uLi8uLic7XG5pbXBvcnQgeyBNQVRDSF9URU1QTEFURV9NT0RFIH0gZnJvbSAnLi9pbWFnZXMnO1xuaW1wb3J0IHsgVzNDX0VMRU1FTlRfS0VZLCBNSlNPTldQX0VMRU1FTlRfS0VZIH0gZnJvbSAnLi4vLi4vcHJvdG9jb2wvcHJvdG9jb2wnO1xuaW1wb3J0IHsgSW1hZ2VFbGVtZW50IH0gZnJvbSAnLi4vaW1hZ2UtZWxlbWVudCc7XG5cblxuY29uc3QgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbnN0IElNQUdFX1NUUkFURUdZID0gXCItaW1hZ2VcIjtcbmNvbnN0IENVU1RPTV9TVFJBVEVHWSA9IFwiLWN1c3RvbVwiO1xuXG4vLyBPdmVycmlkZSB0aGUgZm9sbG93aW5nIGZ1bmN0aW9uIGZvciB5b3VyIG93biBkcml2ZXIsIGFuZCB0aGUgcmVzdCBpcyB0YWtlblxuLy8gY2FyZSBvZiFcblxuLy8gaGVscGVycy5maW5kRWxPckVscyA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpIHt9XG4vLyAgIHN0cmF0ZWd5OiBsb2NhdG9yIHN0cmF0ZWd5XG4vLyAgIHNlbGVjdG9yOiB0aGUgYWN0dWFsIHNlbGVjdG9yIGZvciBmaW5kaW5nIGFuIGVsZW1lbnRcbi8vICAgbXVsdDogbXVsdGlwbGUgZWxlbWVudHMgb3IganVzdCBvbmU/XG4vLyAgIGNvbnRleHQ6IGZpbmRpbmcgYW4gZWxlbWVudCBmcm9tIHRoZSByb290IGNvbnRleHQ/IG9yIHN0YXJ0aW5nIGZyb20gYW5vdGhlciBlbGVtZW50XG4vL1xuLy8gUmV0dXJucyBhbiBvYmplY3Qgd2hpY2ggYWRoZXJlcyB0byB0aGUgd2F5IHRoZSBKU09OIFdpcmUgUHJvdG9jb2wgcmVwcmVzZW50cyBlbGVtZW50czpcbi8vIHsgRUxFTUVOVDogIyB9ICAgIGVnOiB7IEVMRU1FTlQ6IDMgfSAgb3IgeyBFTEVNRU5UOiAxLjAyMyB9XG5cbmhlbHBlcnMuZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpIHtcbiAgdGhpcy52YWxpZGF0ZUxvY2F0b3JTdHJhdGVneShzdHJhdGVneSk7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEVsT3JFbHMoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKHRoaXMub3B0cy5wcmludFBhZ2VTb3VyY2VPbkZpbmRGYWlsdXJlKSB7XG4gICAgICBjb25zdCBzcmMgPSBhd2FpdCB0aGlzLmdldFBhZ2VTb3VyY2UoKTtcbiAgICAgIGxvZy5kZWJ1ZyhgRXJyb3IgZmluZGluZyBlbGVtZW50JHttdWx0ID8gJ3MnIDogJyd9OiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgbG9nLmRlYnVnKGBQYWdlIHNvdXJjZSByZXF1ZXN0ZWQgdGhyb3VnaCAncHJpbnRQYWdlU291cmNlT25GaW5kRmFpbHVyZSc6YCk7XG4gICAgICBsb2cuZGVidWcoc3JjKTtcbiAgICB9XG4gICAgLy8gc3RpbGwgd2FudCB0aGUgZXJyb3IgdG8gb2NjdXJcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmZpbmRFbGVtZW50ID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3Rvcikge1xuICBpZiAoc3RyYXRlZ3kgPT09IElNQUdFX1NUUkFURUdZKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEJ5SW1hZ2Uoc2VsZWN0b3IsIHttdWx0aXBsZTogZmFsc2V9KTtcbiAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gQ1VTVE9NX1NUUkFURUdZKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEJ5Q3VzdG9tKHNlbGVjdG9yLCBmYWxzZSk7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgdGhpcy5maW5kRWxPckVsc1dpdGhQcm9jZXNzaW5nKHN0cmF0ZWd5LCBzZWxlY3RvciwgZmFsc2UpO1xufTtcblxuY29tbWFuZHMuZmluZEVsZW1lbnRzID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3Rvcikge1xuICBpZiAoc3RyYXRlZ3kgPT09IElNQUdFX1NUUkFURUdZKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEJ5SW1hZ2Uoc2VsZWN0b3IsIHttdWx0aXBsZTogdHJ1ZX0pO1xuICB9IGVsc2UgaWYgKHN0cmF0ZWd5ID09PSBDVVNUT01fU1RSQVRFR1kpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kQnlDdXN0b20oc2VsZWN0b3IsIHRydWUpO1xuICB9XG5cbiAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyhzdHJhdGVneSwgc2VsZWN0b3IsIHRydWUpO1xufTtcblxuY29tbWFuZHMuZmluZEVsZW1lbnRGcm9tRWxlbWVudCA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IsIGVsZW1lbnRJZCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5maW5kRWxPckVsc1dpdGhQcm9jZXNzaW5nKHN0cmF0ZWd5LCBzZWxlY3RvciwgZmFsc2UsIGVsZW1lbnRJZCk7XG59O1xuXG5jb21tYW5kcy5maW5kRWxlbWVudHNGcm9tRWxlbWVudCA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IsIGVsZW1lbnRJZCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5maW5kRWxPckVsc1dpdGhQcm9jZXNzaW5nKHN0cmF0ZWd5LCBzZWxlY3RvciwgdHJ1ZSwgZWxlbWVudElkKTtcbn07XG5cbi8qKlxuICogRmluZCBhbiBlbGVtZW50IHVzaW5nIGEgY3VzdG9tIHBsdWdpbiBzcGVjaWZpZWQgYnkgdGhlIGN1c3RvbUZpbmRNb2R1bGVzIGNhcC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gc2VsZWN0b3IgLSB0aGUgc2VsZWN0b3Igd2hpY2ggdGhlIHBsdWdpbiB3aWxsIHVzZSB0byBmaW5kXG4gKiBlbGVtZW50c1xuICogQHBhcmFtIHtib29sZWFufSBtdWx0aXBsZSAtIHdoZXRoZXIgd2Ugd2FudCBvbmUgZWxlbWVudCBvciBtdWx0aXBsZVxuICpcbiAqIEByZXR1cm5zIHtXZWJFbGVtZW50fSAtIFdlYkRyaXZlciBlbGVtZW50IG9yIGxpc3Qgb2YgZWxlbWVudHNcbiAqL1xuY29tbWFuZHMuZmluZEJ5Q3VzdG9tID0gYXN5bmMgZnVuY3Rpb24gKHNlbGVjdG9yLCBtdWx0aXBsZSkge1xuICBjb25zdCBwbHVnaW5zID0gdGhpcy5vcHRzLmN1c3RvbUZpbmRNb2R1bGVzO1xuXG4gIC8vIGZpcnN0IGVuc3VyZSB0aGUgdXNlciBoYXMgcmVnaXN0ZXJlZCBvbmUgb3IgbW9yZSBmaW5kIHBsdWdpbnNcbiAgaWYgKCFwbHVnaW5zKSB7XG4gICAgLy8gVE9ETyB0aGlzIGluZm8gc2hvdWxkIGdvIGluIGRvY3MgaW5zdGVhZDsgdXBkYXRlIHdoZW4gZG9jcyBmb3IgdGhpc1xuICAgIC8vIGZlYXR1cmUgZXhpc3RcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJGaW5kaW5nIGFuIGVsZW1lbnQgdXNpbmcgYSBwbHVnaW4gaXMgY3VycmVudGx5IGFuIFwiICtcbiAgICAgIFwiaW5jdWJhdGluZyBmZWF0dXJlLiBUbyB1c2UgaXQgeW91IG11c3QgbWFudWFsbHkgaW5zdGFsbCBvbmUgb3IgbW9yZSBcIiArXG4gICAgICBcInBsdWdpbiBtb2R1bGVzIGluIGEgd2F5IHRoYXQgdGhleSBjYW4gYmUgcmVxdWlyZWQgYnkgQXBwaXVtLCBmb3IgXCIgK1xuICAgICAgXCJleGFtcGxlIGluc3RhbGxpbmcgdGhlbSBmcm9tIHRoZSBBcHBpdW0gZGlyZWN0b3J5LCBpbnN0YWxsaW5nIHRoZW0gXCIgK1xuICAgICAgXCJnbG9iYWxseSwgb3IgaW5zdGFsbGluZyB0aGVtIGVsc2V3aGVyZSBhbmQgcGFzc2luZyBhbiBhYnNvbHV0ZSBwYXRoIGFzIFwiICtcbiAgICAgIFwidGhlIGNhcGFiaWxpdHkuIFRoZW4gY29uc3RydWN0IGFuIG9iamVjdCB3aGVyZSB0aGUga2V5IGlzIHRoZSBzaG9ydGN1dCBcIiArXG4gICAgICBcIm5hbWUgZm9yIHRoaXMgcGx1Z2luIGFuZCB0aGUgdmFsdWUgaXMgdGhlIG1vZHVsZSBuYW1lIG9yIGFic29sdXRlIHBhdGgsIFwiICtcbiAgICAgIFwiZm9yIGV4YW1wbGU6IHtcXFwicDFcXFwiOiBcXFwibXktZmluZC1wbHVnaW5cXFwifSwgYW5kIHBhc3MgdGhpcyBpbiBhcyB0aGUgXCIgK1xuICAgICAgXCInY3VzdG9tRmluZE1vZHVsZXMnIGNhcGFiaWxpdHkuXCIpO1xuICB9XG5cbiAgLy8gdGhlbiBkbyBzb21lIGJhc2ljIGNoZWNraW5nIG9mIHRoZSB0eXBlIG9mIHRoZSBjYXBhYmlsaXR5XG4gIGlmICghXy5pc1BsYWluT2JqZWN0KHBsdWdpbnMpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBmb3JtYXQgZm9yIHRoZSAnY3VzdG9tRmluZE1vZHVsZXMnIGNhcGFiaWxpdHkuIFwiICtcbiAgICAgIFwiSXQgc2hvdWxkIGJlIGFuIG9iamVjdCB3aXRoIGtleXMgY29ycmVzcG9uZGluZyB0byB0aGUgc2hvcnQgbmFtZXMgYW5kIFwiICtcbiAgICAgIFwidmFsdWVzIGNvcnJlc3BvbmRpbmcgdG8gdGhlIGZ1bGwgbmFtZXMgb2YgdGhlIGVsZW1lbnQgZmluZGluZyBwbHVnaW5zXCIpO1xuICB9XG5cbiAgLy8gZ2V0IHRoZSBuYW1lIG9mIHRoZSBwYXJ0aWN1bGFyIHBsdWdpbiB1c2VkIGZvciB0aGlzIGludm9jYXRpb24gb2YgZmluZCxcbiAgLy8gYW5kIHNlcGFyYXRlIGl0IGZyb20gdGhlIHNlbGVjdG9yIHdlIHdpbGwgcGFzcyB0byB0aGUgcGx1Z2luXG4gIGxldCBbcGx1Z2luLCByZWFsU2VsZWN0b3JdID0gc2VsZWN0b3Iuc3BsaXQoXCI6XCIpO1xuXG4gIC8vIGlmIHRoZSB1c2VyIGRpZG4ndCBzcGVjaWZ5IGEgcGx1Z2luIGZvciB0aGlzIGZpbmQgaW52b2NhdGlvbiwgYW5kIHdlIGhhZFxuICAvLyBtdWx0aXBsZSBwbHVnaW5zIHJlZ2lzdGVyZWQsIHRoYXQncyBhIHByb2JsZW1cbiAgaWYgKF8uc2l6ZShwbHVnaW5zKSA+IDEgJiYgIXJlYWxTZWxlY3Rvcikge1xuICAgIHRocm93IG5ldyBFcnJvcihgTXVsdGlwbGUgZWxlbWVudCBmaW5kaW5nIHBsdWdpbnMgd2VyZSByZWdpc3RlcmVkIGAgK1xuICAgICAgYCgke18ua2V5cyhwbHVnaW5zKX0pLCBidXQgeW91ciBzZWxlY3RvciBkaWQgbm90IGluZGljYXRlIHdoaWNoIHBsdWdpbiBgICtcbiAgICAgIGB0byB1c2UuIEVuc3VyZSB5b3UgcHV0IHRoZSBzaG9ydCBuYW1lIG9mIHRoZSBwbHVnaW4gZm9sbG93ZWQgYnkgJzonIGFzIGAgK1xuICAgICAgYHRoZSBpbml0aWFsIHBhcnQgb2YgdGhlIHNlbGVjdG9yIHN0cmluZy5gKTtcbiAgfVxuXG4gIC8vIGJ1dCBpZiB0aGV5IGRpZCBub3Qgc3BlY2lmeSBhIHBsdWdpbiBhbmQgd2Ugb25seSBoYXZlIG9uZSBwbHVnaW4sIGp1c3QgdXNlXG4gIC8vIHRoYXQgb25lXG4gIGlmIChfLnNpemUocGx1Z2lucykgPT09IDEgJiYgIXJlYWxTZWxlY3Rvcikge1xuICAgIHJlYWxTZWxlY3RvciA9IHBsdWdpbjtcbiAgICBwbHVnaW4gPSBfLmtleXMocGx1Z2lucylbMF07XG4gIH1cblxuICBpZiAoIXBsdWdpbnNbcGx1Z2luXSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgU2VsZWN0b3Igc3BlY2lmaWVkIHVzZSBvZiBlbGVtZW50IGZpbmRpbmcgcGx1Z2luIGAgK1xuICAgICAgYCcke3BsdWdpbn0nIGJ1dCBpdCB3YXMgbm90IHJlZ2lzdGVyZWQgaW4gdGhlICdjdXN0b21GaW5kTW9kdWxlcycgYCArXG4gICAgICBgY2FwYWJpbGl0eS5gKTtcbiAgfVxuXG4gIGxldCBmaW5kZXI7XG4gIHRyeSB7XG4gICAgbG9nLmRlYnVnKGBGaW5kIHBsdWdpbiAnJHtwbHVnaW59JyByZXF1ZXN0ZWQ7IHdpbGwgYXR0ZW1wdCB0byB1c2UgaXQgYCArXG4gICAgICBgZnJvbSAnJHtwbHVnaW5zW3BsdWdpbl19J2ApO1xuICAgIGZpbmRlciA9IHJlcXVpcmUocGx1Z2luc1twbHVnaW5dKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgbG9hZCB5b3VyIGN1c3RvbSBmaW5kIG1vZHVsZSAnJHtwbHVnaW59Jy4gRGlkIGAgK1xuICAgICAgYHlvdSBwdXQgaXQgc29tZXdoZXJlIEFwcGl1bSBjYW4gJ3JlcXVpcmUnIGl0PyBPcmlnaW5hbCBlcnJvcjogJHtlcnJ9YCk7XG4gIH1cblxuICBpZiAoIWZpbmRlciB8fCAhXy5pc0Z1bmN0aW9uKGZpbmRlci5maW5kKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIllvdXIgY3VzdG9tIGZpbmQgbW9kdWxlIGRpZCBub3QgYXBwZWFyIHRvIGJlIGNvbnN0cnVjdGVkIFwiICtcbiAgICAgICAgXCJjb3JyZWN0bHkuIEl0IG5lZWRzIHRvIGV4cG9ydCBhbiBvYmplY3Qgd2l0aCBhIGBmaW5kYCBtZXRob2QuXCIpO1xuICB9XG5cbiAgY29uc3QgY3VzdG9tRmluZGVyTG9nID0gbG9nZ2VyLmdldExvZ2dlcihwbHVnaW4pO1xuXG4gIGxldCBlbGVtZW50cztcbiAgY29uc3QgY29uZGl0aW9uID0gYXN5bmMgKCkgPT4ge1xuICAgIC8vIGdldCBhIGxpc3Qgb2YgbWF0Y2hlZCBlbGVtZW50cyBmcm9tIHRoZSBjdXN0b20gZmluZGVyLCB3aGljaCBjYW5cbiAgICAvLyBwb3RlbnRpYWxseSB1c2UgdGhlIGVudGlyZSBzdWl0ZSBvZiBtZXRob2RzIHRoZSBjdXJyZW50IGRyaXZlciBwcm92aWRlcy5cbiAgICAvLyB0aGUgZmluZGVyIHNob3VsZCBhbHdheXMgcmV0dXJuIGEgbGlzdCBvZiBlbGVtZW50cywgYnV0IG1heSB1c2UgdGhlXG4gICAgLy8ga25vd2xlZGdlIG9mIHdoZXRoZXIgd2UgYXJlIGxvb2tpbmcgZm9yIG9uZSBvciBtYW55IHRvIHBlcmZvcm0gaW50ZXJuYWxcbiAgICAvLyBvcHRpbWl6YXRpb25zXG4gICAgZWxlbWVudHMgPSBhd2FpdCBmaW5kZXIuZmluZCh0aGlzLCBjdXN0b21GaW5kZXJMb2csIHJlYWxTZWxlY3RvciwgbXVsdGlwbGUpO1xuXG4gICAgLy8gaWYgd2UncmUgbG9va2luZyBmb3IgbXVsdGlwbGUgZWxlbWVudHMsIG9yIGlmIHdlJ3JlIGxvb2tpbmcgZm9yIG9ubHlcbiAgICAvLyBvbmUgYW5kIGZvdW5kIGl0LCB3ZSdyZSBkb25lXG4gICAgaWYgKCFfLmlzRW1wdHkoZWxlbWVudHMpIHx8IG11bHRpcGxlKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBvdGhlcndpc2Ugd2Ugc2hvdWxkIHJldHJ5LCBzbyByZXR1cm4gZmFsc2UgdG8gdHJpZ2dlciB0aGUgcmV0cnkgbG9vcFxuICAgIHJldHVybiBmYWxzZTtcbiAgfTtcblxuICB0cnkge1xuICAgIC8vIG1ha2Ugc3VyZSB3ZSByZXNwZWN0IGltcGxpY2l0IHdhaXRcbiAgICBhd2FpdCB0aGlzLmltcGxpY2l0V2FpdEZvckNvbmRpdGlvbihjb25kaXRpb24pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyLm1lc3NhZ2UubWF0Y2goL0NvbmRpdGlvbiB1bm1ldC8pKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cblxuICByZXR1cm4gbXVsdGlwbGUgPyBlbGVtZW50cyA6IGVsZW1lbnRzWzBdO1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBGaW5kQnlJbWFnZU9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW3Nob3VsZENoZWNrU3RhbGVuZXNzPWZhbHNlXSAtIHdoZXRoZXIgdGhpcyBjYWxsIHRvIGZpbmQgYW5cbiAqIGltYWdlIGlzIG1lcmVseSB0byBjaGVjayBzdGFsZW5lc3MuIElmIHNvIHdlIGNhbiBieXBhc3MgYSBsb3Qgb2YgbG9naWNcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW211bHRpcGxlPWZhbHNlXSAtIFdoZXRoZXIgd2UgYXJlIGZpbmRpbmcgb25lIGVsZW1lbnQgb3JcbiAqIG11bHRpcGxlXG4gKi9cblxuLyoqXG4gKiBGaW5kIGEgc2NyZWVuIHJlY3QgcmVwcmVzZW50ZWQgYnkgYW4gSW1hZ2VFbGVtZW50IGNvcnJlc3BvbmRpbmcgdG8gYW4gaW1hZ2VcbiAqIHRlbXBsYXRlIHNlbnQgaW4gYnkgdGhlIGNsaWVudFxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBiNjRUZW1wbGF0ZSAtIGJhc2U2NC1lbmNvZGVkIGltYWdlIHVzZWQgYXMgYSB0ZW1wbGF0ZSB0byBiZVxuICogbWF0Y2hlZCBpbiB0aGUgc2NyZWVuc2hvdFxuICogQHBhcmFtIHtGaW5kQnlJbWFnZU9wdGlvbnN9IC0gYWRkaXRpb25hbCBvcHRpb25zXG4gKlxuICogQHJldHVybnMge1dlYkVsZW1lbnR9IC0gV2ViRHJpdmVyIGVsZW1lbnQgd2l0aCBhIHNwZWNpYWwgaWQgcHJlZml4XG4gKi9cbmhlbHBlcnMuZmluZEJ5SW1hZ2UgPSBhc3luYyBmdW5jdGlvbiAoYjY0VGVtcGxhdGUsIHtcbiAgc2hvdWxkQ2hlY2tTdGFsZW5lc3MgPSBmYWxzZSxcbiAgbXVsdGlwbGUgPSBmYWxzZSxcbn0pIHtcbiAgY29uc3Qge1xuICAgIGltYWdlTWF0Y2hUaHJlc2hvbGQ6IHRocmVzaG9sZCxcbiAgICBmaXhJbWFnZVRlbXBsYXRlU2l6ZVxuICB9ID0gdGhpcy5zZXR0aW5ncy5nZXRTZXR0aW5ncygpO1xuXG4gIGxvZy5pbmZvKGBGaW5kaW5nIGltYWdlIGVsZW1lbnQgd2l0aCBtYXRjaCB0aHJlc2hvbGQgJHt0aHJlc2hvbGR9YCk7XG4gIGlmICghdGhpcy5nZXRXaW5kb3dTaXplKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVGhpcyBkcml2ZXIgZG9lcyBub3Qgc3VwcG9ydCB0aGUgcmVxdWlyZWQgJ2dldFdpbmRvd1NpemUnIGNvbW1hbmRcIik7XG4gIH1cbiAgY29uc3Qge3dpZHRoOiBzY3JlZW5XaWR0aCwgaGVpZ2h0OiBzY3JlZW5IZWlnaHR9ID0gYXdhaXQgdGhpcy5nZXRXaW5kb3dTaXplKCk7XG5cbiAgLy8gc29tZW9uZSBtaWdodCBoYXZlIHNlbnQgaW4gYSB0ZW1wbGF0ZSB0aGF0J3MgbGFyZ2VyIHRoYW4gdGhlIHNjcmVlblxuICAvLyBkaW1lbnNpb25zLiBJZiBzbyBsZXQncyBjaGVjayBhbmQgY3V0IGl0IGRvd24gdG8gc2l6ZSBzaW5jZSB0aGUgYWxnb3JpdGhtXG4gIC8vIHdpbGwgbm90IHdvcmsgdW5sZXNzIHdlIGRvLiBCdXQgYmVjYXVzZSBpdCByZXF1aXJlcyBzb21lIHBvdGVudGlhbGx5XG4gIC8vIGV4cGVuc2l2ZSBjb21tYW5kcywgb25seSBkbyB0aGlzIGlmIHRoZSB1c2VyIGhhcyByZXF1ZXN0ZWQgaXQgaW4gc2V0dGluZ3MuXG4gIGlmIChmaXhJbWFnZVRlbXBsYXRlU2l6ZSkge1xuICAgIGI2NFRlbXBsYXRlID0gYXdhaXQgdGhpcy5lbnN1cmVUZW1wbGF0ZVNpemUoYjY0VGVtcGxhdGUsIHNjcmVlbldpZHRoLFxuICAgICAgc2NyZWVuSGVpZ2h0KTtcbiAgfVxuXG4gIGxldCByZWN0ID0gbnVsbDtcbiAgY29uc3QgY29uZGl0aW9uID0gYXN5bmMgKCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBsZXQgYjY0U2NyZWVuc2hvdCA9IGF3YWl0IHRoaXMuZ2V0U2NyZWVuc2hvdEZvckltYWdlRmluZChzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0KTtcbiAgICAgIHJlY3QgPSAoYXdhaXQgdGhpcy5jb21wYXJlSW1hZ2VzKE1BVENIX1RFTVBMQVRFX01PREUsIGI2NFNjcmVlbnNob3QsXG4gICAgICAgIGI2NFRlbXBsYXRlLCB7dGhyZXNob2xkfSkpLnJlY3Q7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIGlmIGNvbXBhcmVJbWFnZXMgZmFpbHMsIHdlJ2xsIGdldCBhIHNwZWNpZmljIGVycm9yLCBidXQgd2Ugc2hvdWxkXG4gICAgICAvLyByZXRyeSwgc28gdHJhcCB0aGF0IGFuZCBqdXN0IHJldHVybiBmYWxzZSB0byB0cmlnZ2VyIHRoZSBuZXh0IHJvdW5kIG9mXG4gICAgICAvLyBpbXBsaWNpdGx5IHdhaXRpbmcuIEZvciBvdGhlciBlcnJvcnMsIHRocm93IHRoZW0gdG8gZ2V0IG91dCBvZiB0aGVcbiAgICAgIC8vIGltcGxpY2l0IHdhaXQgbG9vcFxuICAgICAgaWYgKGVyci5tZXNzYWdlLm1hdGNoKC9DYW5ub3QgZmluZCBhbnkgb2NjdXJyZW5jZXMvKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9O1xuXG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5pbXBsaWNpdFdhaXRGb3JDb25kaXRpb24oY29uZGl0aW9uKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gdGhpcyBgaW1wbGljaXRXYWl0Rm9yQ29uZGl0aW9uYCBtZXRob2Qgd2lsbCB0aHJvdyBhICdDb25kaXRpb24gdW5tZXQnXG4gICAgLy8gZXJyb3IgaWYgYW4gZWxlbWVudCBpcyBub3QgZm91bmQgZXZlbnR1YWxseS4gSW4gdGhhdCBjYXNlLCB3ZSB3aWxsXG4gICAgLy8gaGFuZGxlIHRoZSBlbGVtZW50IG5vdCBmb3VuZCByZXNwb25zZSBiZWxvdy4gSW4gdGhlIGNhc2Ugd2hlcmUgZ2V0IHNvbWVcbiAgICAvLyBfb3RoZXJfIGtpbmQgb2YgZXJyb3IsIGl0IG1lYW5zIHNvbWV0aGluZyBibGV3IHVwIHRvdGFsbHkgYXBhcnQgZnJvbSB0aGVcbiAgICAvLyBpbXBsaWNpdCB3YWl0IHRpbWVvdXQuIFdlIHNob3VsZCBub3QgbWFzayB0aGF0IGVycm9yIGFuZCBpbnN0ZWFkIHRocm93XG4gICAgLy8gaXQgc3RyYWlnaHRhd2F5XG4gICAgaWYgKCFlcnIubWVzc2FnZS5tYXRjaCgvQ29uZGl0aW9uIHVubWV0LykpIHtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH1cblxuICBpZiAoIXJlY3QpIHtcbiAgICBpZiAobXVsdGlwbGUpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbiAgfVxuXG4gIGxvZy5pbmZvKGBJbWFnZSB0ZW1wbGF0ZSBtYXRjaGVkOiAke0pTT04uc3RyaW5naWZ5KHJlY3QpfWApO1xuICBjb25zdCBpbWdFbCA9IG5ldyBJbWFnZUVsZW1lbnQoYjY0VGVtcGxhdGUsIHJlY3QpO1xuXG4gIC8vIGlmIHdlJ3JlIGp1c3QgY2hlY2tpbmcgc3RhbGVuZXNzLCByZXR1cm4gc3RyYWlnaHRhd2F5IHNvIHdlIGRvbid0IGFkZFxuICAvLyBhIG5ldyBlbGVtZW50IHRvIHRoZSBjYWNoZS4gc2hvdWxkQ2hlY2tTdGFsZW5lc3MgZG9lcyBub3Qgc3VwcG9ydCBtdWx0aXBsZVxuICAvLyBlbGVtZW50cywgc2luY2UgaXQgaXMgYSBwdXJlbHkgaW50ZXJuYWwgbWVjaGFuaXNtXG4gIGlmIChzaG91bGRDaGVja1N0YWxlbmVzcykge1xuICAgIHJldHVybiBpbWdFbDtcbiAgfVxuXG4gIHRoaXMuX2ltZ0VsQ2FjaGUuc2V0KGltZ0VsLmlkLCBpbWdFbCk7XG4gIGNvbnN0IHByb3RvS2V5ID0gdGhpcy5pc1czQ1Byb3RvY29sKCkgPyBXM0NfRUxFTUVOVF9LRVkgOiBNSlNPTldQX0VMRU1FTlRfS0VZO1xuICBjb25zdCBwcm90b2NvbEVsID0gaW1nRWwuYXNFbGVtZW50KHByb3RvS2V5KTtcbiAgcmV0dXJuIG11bHRpcGxlID8gW3Byb3RvY29sRWxdIDogcHJvdG9jb2xFbDtcbn07XG5cbi8qKlxuICogRW5zdXJlIHRoYXQgdGhlIGltYWdlIHRlbXBsYXRlIHNlbnQgaW4gZm9yIGEgZmluZCBpcyBvZiBhIHN1aXRhYmxlIHNpemVcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYjY0VGVtcGxhdGUgLSBiYXNlNjQtZW5jb2RlZCBpbWFnZVxuICogQHBhcmFtIHtpbnR9IHNjcmVlbldpZHRoIC0gd2lkdGggb2Ygc2NyZWVuXG4gKiBAcGFyYW0ge2ludH0gc2NyZWVuSGVpZ2h0IC0gaGVpZ2h0IG9mIHNjcmVlblxuICpcbiAqIEByZXR1cm5zIHtzdHJpbmd9IGJhc2U2NC1lbmNvZGVkIGltYWdlLCBwb3RlbnRpYWxseSByZXNpemVkXG4gKi9cbmhlbHBlcnMuZW5zdXJlVGVtcGxhdGVTaXplID0gYXN5bmMgZnVuY3Rpb24gKGI2NFRlbXBsYXRlLCBzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0KSB7XG4gIGxldCBpbWdPYmogPSBhd2FpdCBpbWFnZVV0aWwuZ2V0SmltcEltYWdlKGI2NFRlbXBsYXRlKTtcbiAgbGV0IHt3aWR0aDogdHBsV2lkdGgsIGhlaWdodDogdHBsSGVpZ2h0fSA9IGltZ09iai5iaXRtYXA7XG5cbiAgLy8gaWYgdGhlIHRlbXBsYXRlIGZpdHMgaW5zaWRlIHRoZSBzY3JlZW4gZGltZW5zaW9ucywgd2UncmUgZ29vZFxuICBpZiAodHBsV2lkdGggPD0gc2NyZWVuV2lkdGggJiYgdHBsSGVpZ2h0IDw9IHNjcmVlbkhlaWdodCkge1xuICAgIHJldHVybiBiNjRUZW1wbGF0ZTtcbiAgfVxuXG4gIC8vIG90aGVyd2lzZSwgc2NhbGUgaXQgdG8gZml0IGluc2lkZSB0aGUgc2NyZWVuIGRpbWVuc2lvbnNcbiAgaW1nT2JqID0gaW1nT2JqLnNjYWxlVG9GaXQoc2NyZWVuV2lkdGgsIHNjcmVlbkhlaWdodCk7XG4gIHJldHVybiAoYXdhaXQgaW1nT2JqLmdldEJ1ZmZlcihpbWFnZVV0aWwuTUlNRV9QTkcpKS50b1N0cmluZygnYmFzZTY0Jyk7XG59O1xuXG4vKipcbiAqIEdldCB0aGUgc2NyZWVuc2hvdCBpbWFnZSB0aGF0IHdpbGwgYmUgdXNlZCBmb3IgZmluZCBieSBlbGVtZW50LCBwb3RlbnRpYWxseVxuICogYWx0ZXJpbmcgaXQgaW4gdmFyaW91cyB3YXlzIGJhc2VkIG9uIHVzZXItcmVxdWVzdGVkIHNldHRpbmdzXG4gKlxuICogQHBhcmFtIHtpbnR9IHNjcmVlbldpZHRoIC0gd2lkdGggb2Ygc2NyZWVuXG4gKiBAcGFyYW0ge2ludH0gc2NyZWVuSGVpZ2h0IC0gaGVpZ2h0IG9mIHNjcmVlblxuICpcbiAqIEByZXR1cm5zIHtzdHJpbmd9IGJhc2U2NC1lbmNvZGVkIHNjcmVlbnNob3RcbiAqL1xuaGVscGVycy5nZXRTY3JlZW5zaG90Rm9ySW1hZ2VGaW5kID0gYXN5bmMgZnVuY3Rpb24gKHNjcmVlbldpZHRoLCBzY3JlZW5IZWlnaHQpIHtcbiAgaWYgKCF0aGlzLmdldFNjcmVlbnNob3QpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJUaGlzIGRyaXZlciBkb2VzIG5vdCBzdXBwb3J0IHRoZSByZXF1aXJlZCAnZ2V0U2NyZWVuc2hvdCcgY29tbWFuZFwiKTtcbiAgfVxuXG4gIGxldCBiNjRTY3JlZW5zaG90ID0gYXdhaXQgdGhpcy5nZXRTY3JlZW5zaG90KCk7XG5cbiAgLy8gaWYgdGhlIHVzZXIgaGFzIHJlcXVlc3RlZCBub3QgdG8gY29ycmVjdCBmb3IgYXNwZWN0IG9yIHNpemUgZGlmZmVyZW5jZXNcbiAgLy8gYmV0d2VlbiB0aGUgc2NyZWVuc2hvdCBhbmQgdGhlIHNjcmVlbiwganVzdCByZXR1cm4gdGhlIHNjcmVlbnNob3Qgbm93XG4gIGlmICghdGhpcy5zZXR0aW5ncy5nZXRTZXR0aW5ncygpLmZpeEltYWdlRmluZFNjcmVlbnNob3REaW1zKSB7XG4gICAgbG9nLmluZm8oYE5vdCB2ZXJpZnlpbmcgc2NyZWVuc2hvdCBkaW1lbnNpb25zIG1hdGNoIHNjcmVlbmApO1xuICAgIHJldHVybiBiNjRTY3JlZW5zaG90O1xuICB9XG5cbiAgLy8gb3RoZXJ3aXNlLCBkbyBzb21lIHZlcmlmaWNhdGlvbiBvbiB0aGUgc2NyZWVuc2hvdCB0byBtYWtlIHN1cmUgaXQgbWF0Y2hlc1xuICAvLyB0aGUgc2NyZWVuIHNpemUgYW5kIGFzcGVjdCByYXRpb1xuICBsb2cuaW5mbygnVmVyaWZ5aW5nIHNjcmVlbnNob3Qgc2l6ZSBhbmQgYXNwZWN0IHJhdGlvJyk7XG5cbiAgbGV0IGltZ09iaiA9IGF3YWl0IGltYWdlVXRpbC5nZXRKaW1wSW1hZ2UoYjY0U2NyZWVuc2hvdCk7XG4gIGxldCB7d2lkdGg6IHNob3RXaWR0aCwgaGVpZ2h0OiBzaG90SGVpZ2h0fSA9IGltZ09iai5iaXRtYXA7XG5cbiAgaWYgKHNjcmVlbldpZHRoID09PSBzaG90V2lkdGggJiYgc2NyZWVuSGVpZ2h0ID09PSBzaG90SGVpZ2h0KSB7XG4gICAgLy8gdGhlIGhlaWdodCBhbmQgd2lkdGggb2YgdGhlIHNjcmVlbnNob3QgYW5kIHRoZSBkZXZpY2Ugc2NyZWVuIG1hdGNoLCB3aGljaFxuICAgIC8vIG1lYW5zIHdlIHNob3VsZCBiZSBzYWZlIHdoZW4gZG9pbmcgdGVtcGxhdGUgbWF0Y2hlc1xuICAgIGxvZy5pbmZvKCdTY3JlZW5zaG90IHNpemUgbWF0Y2hlZCBzY3JlZW4gc2l6ZScpO1xuICAgIHJldHVybiBiNjRTY3JlZW5zaG90O1xuICB9XG5cbiAgLy8gb3RoZXJ3aXNlLCBpZiB0aGV5IGRvbid0IG1hdGNoLCBpdCBjb3VsZCBzcGVsbCBwcm9ibGVtcyBmb3IgdGhlIGFjY3VyYWN5XG4gIC8vIG9mIGNvb3JkaW5hdGVzIHJldHVybmVkIGJ5IHRoZSBpbWFnZSBtYXRjaCBhbGdvcml0aG0sIHNpbmNlIHdlIG1hdGNoIGJhc2VkXG4gIC8vIG9uIHRoZSBzY3JlZW5zaG90IGNvb3JkaW5hdGVzIG5vdCB0aGUgZGV2aWNlIGNvb3JkaW5hdGVzIHRoZW1zZWx2ZXMuIFRoZXJlXG4gIC8vIGFyZSB0d28gcG90ZW50aWFsIHR5cGVzIG9mIG1pc21hdGNoOiBhc3BlY3QgcmF0aW8gbWlzbWF0Y2ggYW5kIHNjYWxlXG4gIC8vIG1pc21hdGNoLiB3ZSBuZWVkIHRvIGRldGVjdCBhbmQgZml4IGJvdGhcblxuICBjb25zdCBzY3JlZW5BUiA9IHNjcmVlbldpZHRoIC8gc2NyZWVuSGVpZ2h0O1xuICBjb25zdCBzaG90QVIgPSBzaG90V2lkdGggLyBzaG90SGVpZ2h0O1xuXG4gIGlmIChzY3JlZW5BUiA9PT0gc2hvdEFSKSB7XG4gICAgbG9nLmluZm8oJ1NjcmVlbnNob3QgYXNwZWN0IHJhdGlvIG1hdGNoZWQgc2NyZWVuIGFzcGVjdCByYXRpbycpO1xuICB9IGVsc2Uge1xuICAgIGxvZy53YXJuKGBXaGVuIHRyeWluZyB0byBmaW5kIGFuIGVsZW1lbnQsIGRldGVybWluZWQgdGhhdCB0aGUgc2NyZWVuIGAgK1xuICAgICAgICAgICAgIGBhc3BlY3QgcmF0aW8gYW5kIHNjcmVlbnNob3QgYXNwZWN0IHJhdGlvIGFyZSBkaWZmZXJlbnQuIFNjcmVlbiBgICtcbiAgICAgICAgICAgICBgaXMgJHtzY3JlZW5XaWR0aH14JHtzY3JlZW5IZWlnaHR9IHdoZXJlYXMgc2NyZWVuc2hvdCBpcyBgICtcbiAgICAgICAgICAgICBgJHtzaG90V2lkdGh9eCR7c2hvdEhlaWdodH0uYCk7XG4gICAgc2hvdFdpZHRoID0gc2hvdFdpZHRoIC8gKHNob3RBUiAvIHNjcmVlbkFSKTtcbiAgICBsb2cud2FybihgUmVzaXppbmcgc2NyZWVuc2hvdCB0byAke3Nob3RXaWR0aH14JHtzaG90SGVpZ2h0fSB0byBtYXRjaCBgICtcbiAgICAgICAgICAgICBgc2NyZWVuIGFzcGVjdCByYXRpbyBzbyB0aGF0IGltYWdlIGVsZW1lbnQgY29vcmRpbmF0ZXMgaGF2ZSBhIGAgK1xuICAgICAgICAgICAgIGBncmVhdGVyIGNoYW5jZSBvZiBiZWluZyBjb3JyZWN0LmApO1xuICAgIGltZ09iaiA9IGltZ09iai5yZXNpemUoc2hvdFdpZHRoLCBzaG90SGVpZ2h0KTtcbiAgfVxuXG4gIC8vIG5vdyB3ZSBrbm93IHRoZSBhc3BlY3QgcmF0aW9zIG1hdGNoLCBidXQgdGhlcmUgbWlnaHQgc3RpbGwgYmUgYSBzY2FsZVxuICAvLyBtaXNtYXRjaCwgc28ganVzdCByZXNpemUgYmFzZWQgb24gdGhlIHNjcmVlbiBkaW1lbnNpb25zXG4gIGlmIChzY3JlZW5XaWR0aCAhPT0gc2hvdFdpZHRoKSB7XG4gICAgbG9nLmluZm8oYFNjYWxpbmcgc2NyZWVuc2hvdCBmcm9tICR7c2hvdFdpZHRofXgke3Nob3RIZWlnaHR9IHRvIG1hdGNoIGAgK1xuICAgICAgICAgICAgIGBzY3JlZW4gYXQgJHtzY3JlZW5XaWR0aH14JHtzY3JlZW5IZWlnaHR9YCk7XG4gICAgaW1nT2JqID0gaW1nT2JqLnJlc2l6ZShzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0KTtcbiAgfVxuXG4gIHJldHVybiAoYXdhaXQgaW1nT2JqLmdldEJ1ZmZlcihpbWFnZVV0aWwuTUlNRV9QTkcpKS50b1N0cmluZygnYmFzZTY0Jyk7XG59O1xuXG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMsIElNQUdFX1NUUkFURUdZLCBDVVNUT01fU1RSQVRFR1kgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL2ZpbmQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4ifQ==
